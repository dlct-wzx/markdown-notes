# 计算机网络

[TOC]

# 第一章 概述

## 1.1 因特网概述

### 网络、互联网和因特网的组成

**网络：**若干**节点**和**链路**互连形成**网络**

**互连网（互联网）：**若干网络通过**路由器**互连形成

**因特网（Internet）：**世界上最大的互联网

### 因特网发展的三个阶段

![image-20220922173738083](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/7ebbb8b4548fd06a3943861f0d03d30d4cf8afc3.png)

**ISP（因特网服务提供者）：**ISP向因特网申请IP地址块，ISP再向用户分配IP地址

因特网已发展成为基于**ISP的多层次结构的互连网络**

![image-20220922174241225](https://i0.hdslb.com/bfs/album/15423e331cec245e610e20ef0058d2047db26aa8.png)

### 因特网的组成

**边缘部分：**由所有连接在因特网上的 **主机** 组成。这部分是 **用户直接使用** 的，用来进行 **通信** 和 **资源共享**

**核心部分：**由 **大量网络** 和连接这些网络的 **路由器** 组成。这部分是 **为边缘部分提供服务（提供连通性和交换）**

## 1.2 电路交换、分组交换和报文交换

### 电路交换（Circuit Switch）

电话交换机接通电话线的方式成为电路交换

从通信资源的分配角度来看，**交换（Switch）**就是按照某种方式动态地分配传输线路的资源

电路交换的三个步骤

- 建立连接（分配通信资源）
- 通话（一直占用通信资源）
- 释放连接（归还通信资源）

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/c0312fd007d8f895f4a86ccc44dc2c3c1b6ddea8.png" alt="image-20220922175257953" style="zoom:67%;" />

**计算机之间的数据传送是突发式**的，当**使用电路交换**来传送计算机数据时，其线路的**传输效率一般都会很低**，线路上真正用来传送数据的时间往往不到10%甚至1%

### 报文交换（Message Switching）

报文交换是分组交换的前身

在报文交换中，**报文被整个地发送**，而不是拆分成若干个分组进行发送

交换节点将报文**整体接收完成后**才能查找转发表，将整个报文**转发**到下一个节点

报文交换比分组交换带来的**转发时延要长很多**，需要交换节点具有的**缓存空间也大很多**

### 分组交换（Packet Switching）

发送方：构造分组、发送分组

路由器：缓存分组、转发分组

接收方：接受分组、还原报文

将报文进行分组，将每组报文添加一个**首部（存放报文信息）**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/2904d1faacc6724fdee32052c288dbf723f39b8e.png" alt="image-20220922192056672" style="zoom:67%;" />

### 电路交换、报文交换、分组交换的对比

![image-20220922192903172](https://i0.hdslb.com/bfs/album/ea6ecf3de4a75d6c97492932bee96df5109adf07.png)

| 方式     | 优点                                                         | 缺点                                                         |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 电路交换 | 1.通信时延小 2.有序传输 3.没有冲突 4.通用范围广 5.使用性强 6.控制简单 | 1.建立连接时间长 2.线路独占，使用效率低 3.灵活性差 4.难以规格化 |
| 报文交换 | 1.无需建立连接 2.动态分配线路 3.提高线路可靠性 4.提高线路利用率 5.提供多目标服务 | 1.引起转发时延 2.需要较大存储缓存空间 3.需要传输额外的信息量 |
| 分组交换 | 1.无需建立连接 2.线路利用率高 3.简化了存储管理 3.加速传输 4.减少出错概率和重发数据量 | 1.引起转发时延 2.需要传输额外的信息量 3.无法确保通信时端到端通信资源全部可用，在通信量较大时可能造成网络拥塞 |

## 1.3 计算网络的定义和分类

### 计算机网络的定义

计算机网络的**最简单**的定义：一些**互相连接**的、**自洽**的计算机的**集合**

计算机网络的**较好**的定义：**计算机网络主要是由一些==通用的、可编程的硬件互连==而成的，而这些硬件并非专门用来实现某一特定目的（例如，传送数据或视频信号）。这些可编程的硬件能够用来==传送多种不同类型的数据==，并能==支持广泛的和日益增长的应用==。**

### 计算机网络的分类

**按交换技术分类**

- 电路交换网络
- 报文交换网络
- 分组交换网络

**按使用者分类**

- 公用网
- 专用网

**按传输介质分类**

- 有限网络
- 无线网络

**按覆盖范围分类**

- **广域网WAN**（几十到几千千米）
- **城域网MAN**（5到50千米）
- **局域网LAN**（1千米左右）
- **个域网PAN**（10米）

**按拓扑结构分类**

- 总线型网络
- 星型网络
- 环型网络
- 环型网络
- 网状型网络

<img src="https://i0.hdslb.com/bfs/album/cf6b693d4b83a4fe2e202613e43fa53b7d9dfa55.png" alt="image-20220922201329969" style="zoom:70%;" />

## 1.4 计算机网络的性能指标

**常用的计算机网络性能指标**

- **速率**
- **带宽**
- **吞吐量**
- **时延**
- **时延带宽积**
- **往返实践**
- **利用率**
- **丢包率**

**速率**

**比特：**计算机中 **数据量的单位**
$$
单位为：bit \\
1\ bit = 0/1\\
8\ bit = 1\ Byte\\
KB=2^{10}B\\
MB=2^{20}B\\
GB=2^{30}B\\
TB=2^{40}B\\
$$


**速率（比特率、数据率）：**连接在计算机网络上的主机在数字信道上传送比特的速率
$$
单位为：bit/s(b/s, bps)\\
kbps=10^{3}bps\\
Mbps=10^{6}bps\\
Gbps=10^{9}bps\\
Tbps=10^{12}bps
$$



**带宽**

带宽在**模拟信号系统**中的意义

- **信号** 所包含的各种不同频率成分所占据的 **频率范围**
- 单位：$Hz(kHz,MHz,GHz)$

带宽在 **计算机网络** 中的一样

- 用来表示网络的 **通信线路** 所能传送数据的能力，因此网络带宽表示在单位时间内从网络中的某一点到另一点所能通过的 **最高速率**
- 单位：$b/s(kb/s,Mb/s,Gb/s,Tb/s)$



**吞吐量**

吞吐量是指在**单位时间内通过某个网络或接口的实际数据量**

吞吐量常被用于对实际网络的测量，以便获知到底有多少数据量通过了网络

吞吐量**受网络带宽的限制**



**时延**
$$
发送时延=\frac{分组长度(b)}{发送速率(b/s)} \\
传播时延=\frac{信道长度(m)}{电磁波传输速率(m/s)}\\
处理时延一般不方便计算
$$

![image-20220922203850637](https://i0.hdslb.com/bfs/album/9472739fc50778e6e4e70759d7eb73489af65d99.png)



**时延带宽积**

<img src="https://i0.hdslb.com/bfs/album/f5cf30bc92e3bfa7030edf79f2bb332461207a80.png" alt="image-20220922203957400" style="zoom:67%;" />

若发送端连续发送数据，则在所发送的第一个比特他即将到达终点时，发送端就已经发送了时延带宽积个比特

联络的时延带宽积又称为 **以比特为单位的链路长度**



**往返时间**

许多情况下，因特网上的信息是双向交互的

因此，双向交互的时间，往返时间 **RTT（Round-Trip Time）**也是一个重要的性能指标



**利用率**

![image-20220922204522496](https://i0.hdslb.com/bfs/album/6deed22605cdb4e6d6c390a18f43c701ffaabf49.png)

根据排队论可知，**当某链路的利用率增大时，该链路引起的时延就会迅速增加**

**信道利用率并非越高越好**

令$D_0$表示网络空闲时的时延，$D$表示网络当前的时延，那么在理想的假定条件下，可用下式来表示$D、D_0$和网络利用率U之间的关系
$$
D=\frac{D_0}{1-D_0}
$$



**丢包率**

丢包率是指在一定的时间范围内，传输过程中**丢失的分组数量与总分组数量的比率**

**分组丢失主要有以下两种情况：**

- 分组在传输过程中出现**误码**，被传输路径中的节点交换机（例如路由器）或目的主机检测出误码而丢弃
- 节点交换机根据**丢弃策略**主动丢弃分组

**丢包率可以反映网络的拥塞情况**



## 1.5 计算机网络体系结构

### 常见的计算机网络体系结构

![image-20220924105907753](https://i0.hdslb.com/bfs/album/9db1e434d1618a70fca87a49465f3daf463a3357.png)

![image-20220924105654274](https://i0.hdslb.com/bfs/album/c2dc7a6f7cc5383f36d2d709099c4d2031b84b4b.png)

### 计算机网络分层的必要性

**物理层需要考虑的问题**

- 采用什么传输媒体**（介质）**
- 采用什么**物理接口**
- 采用什么信号表示比特0和1

**数据链路层需要考虑的问题**

- 标识网络中各主机（**主机编址**，例如MAC地址）
- 从比特流中区分出地址和数据（**数据封装格式**）
- 协调各主机争用总线（**媒体接入控制**）

**网络层需要考虑的问题**

- 标识网络和网络中的各主机（**网络和主机共同编址**，例如IP地址）
- 路由器转发分组（**路由选择协议、路由表和转发表**）

**运输层需要考虑的问题**

- 进程之间基于网络的通信（**进程的标识**，例如端口号）
- 出现传输差错如何处理（**可靠传输和不可靠传输**）

**应用层需要考虑的问题**

- 通过应用进程间的交互来完成特定的网络应用

**总结**

![image-20220924165054194](https://i0.hdslb.com/bfs/album/3859e875d235b82bb5eba898730c5f2987e9c0be.png)

### 计算机网络结构分层思想举例

![image-20220924170313010](https://i0.hdslb.com/bfs/album/465d06addf2c2dfac5ac316f25312219cfedec99.png)

![image-20220924170253246](https://i0.hdslb.com/bfs/album/68d58b18489ea0b99fca6f5b44db4ea11dca190e.png)

### 计算机网络体系结构专业术语

**实体**

- **实体：**任何可发送或接受信息的 **硬件** 或 **软件进程**
- **对等实体：**收发双方 **相同层次中的实体**

![image-20220924170514342](https://i0.hdslb.com/bfs/album/04e1ed83aff449a6e1e254b62e855523489d214e.png)

**协议**

- 控制两个对等实体进行逻辑通信的规则的集合
- **协议三要素：**语法、语义、同步
  - **语法：**定义所交换信息的格式
  - **语义：**定义收发双方所要完成的操作
  - **同步：**定义收发双方的时序关系

![image-20220924170642301](https://i0.hdslb.com/bfs/album/94dea62b8a1e49866c98afffeadd239ef21afa3e.png)

**服务**

- **服务：**在协议的控制下，两个对等实体间的逻辑通信使得本层能够向上一层提供服务
  - 要实现本层协议，还需要使用下面一层所提供的服务
  - 协议是 **水平的**，服务是 **垂直的**
  - 实体看的见相邻下层所提供的服务，但不知到实现该服务的具体信息（限免的协议对上面的实体是 **透明的**）
- **服务访问节点：**在同一系统中 **相邻两层的实体交换信息的逻辑接口**，用于区分不同的服务类型

![image-20220924171308101](https://i0.hdslb.com/bfs/album/1c1f89c7d9c9cd5b2c34fdc192e81ffea7ebf3d0.png)



# 第二章 物理层

## 2.1 物理层概述

**物理层用来透明的==传输==传输比特流**

**物理层为数据**

**物理层的接口特性：**

![](https://i0.hdslb.com/bfs/album/bc9e259d455f2fe38eacec5bfad31c650679167c.png)

## 2.2 物理层下面的传输媒体

**传输媒体**是计算机网络设备之间的物理通路，也称为传输介质或传输媒体

- 导引型传输媒体：同轴电缆、双绞线、光纤、电力线
- 非导引型传输媒体：无线电波、微波、红外线、可见光

传输媒体并**不包含在计算机网络体系结构中**

物理层知道发送的比特流信息（0/1），传输媒体不知道

<img src="https://i0.hdslb.com/bfs/album/2ceacf616312873ecb6e91012d9952d9274afb87.png" alt="image-20220925090736011" style="zoom:67%;" />

## 2.3传输方式

**并行与串行**

- **并行传输**：数据以成组的方式在多个并行信道上同时进行传输叫做并行传输（一次一字节）
  - 特点：**速度快，费用高**

- **串行传输**：数据流以串行方式在一条信道上传输

- **远程传输使用串行传输 **

**同步与异步传输**

- **同步传输：**数据以块或帧的形式发送。此传输是全双工类型。在发送者和接收者之间强制性同步。在同步传输中，数据之间没有间隙。与异步传输相比，传输大量数据更加有效和可靠
- **异步传输：**数据以字节或字符的形式发送。该传输是半双工型传输。在该传输中，在数据的起始位和停止位都添加了奇偶校验位。它不需要同步

**单向、双向交替、双向同时通信**

- **单项通信（单工）**：单向传输 一条信道
- **双向交替通信（半双工）**：双向交替传输 两条信道
- **双向同时通信（全双工）**：双向同时传输 两条信道

## 2.4编码与调制

![image-20220925223502535](https://i0.hdslb.com/bfs/album/ace8011f3fc1f5689ee5eda35f10a109921d4180.png)

**码元**：在使用时间域的波形表示信号时，代表不同离散数值的**基本波形**称为码元

eg：<img src="https://i0.hdslb.com/bfs/album/0bfc6186346262fe19f9f76bc0d4b208d82b73b3.png" alt="image-20220926211344054" style="zoom:67%;" />

### 常用编码方式

**不归零编码**：编码效率高，但存在同步问题。需要 **添加一条时钟信号线**

![image-20220926211723102](https://i0.hdslb.com/bfs/album/c02905536eb257768da45ec9742fa13a727253b6.png)

**归零编码**：将时钟信号使用归零的方式编码在数据中（**自同步**信号），但是大部分的 **数据带宽**都用来传输归零而 **浪费** 了

![image-20220926211930439](https://i0.hdslb.com/bfs/album/8eeb13c0a4e1ca0819fa2ba97f33a8916b2b4b8c.png)

**曼彻斯特编码**：**自同步编码**

![image-20220926212020568](https://i0.hdslb.com/bfs/album/483d1b2b7f38354bb54412aa21aaa88ddc5618ae.png)

**差分曼彻斯特编码**

![image-20220926212234509](https://i0.hdslb.com/bfs/album/e31f8f44763df484ac47416ebdc96dcb66c7d680.png)

### 基本调制方法

**使用基本调制方法一个码元只包含一个bit**

![image-20220926212448153](https://i0.hdslb.com/bfs/album/782d7f22912b24219a965f6887d47f1d007c41f2.png)

### 混合调制

**载波的相位和振幅可以结合起来一起调制，eg ==正交振幅调制QAM==**

**正交振幅调制QAM-16**

- 可以调制出16种码元（波形），每种码元可以对应表示4个bit

- 码元与4个bit的对应关系采用格雷码，任意相邻两个码元只用1个bit不同

<img src="https://i0.hdslb.com/bfs/album/20469ebd9c5eedc6c450146ab3ffd5cbb94c27f3.png" alt="image-20220926213014092" style="zoom:67%;" />

## 2.5 信道的极限容量

### 造成信号失真的主要因素

![image-20220926214932083](https://i0.hdslb.com/bfs/album/b218c5fe6f07b8702d84d2b49aa218f5c6376df9.png)

### 奈氏准则

在假定的理想条件下，**为了避免码间串扰，码元传输的速率是有上限的**
$$
理想低通信道的最高码元传输速率=2W*Baud=2w*码元/秒 \\
理想带通信道的最高码元传输速率=W*Baud=w*码元/秒 \\
W:信道带宽(单位Hz) \ \ \ Baud:波特(码元/秒)
$$
**码元传输速率又称波特率、调制速率、波形速率或符号速率**
$$
数值上：波特率(码元/秒)=n*比特率(bit/秒) \\
n:一个码元携带多少bit
$$
**奈氏准则是最高码元速率**

### 香农公式

**带宽受限且有高斯白噪声干扰的信道的极限信息传输速率**
$$
c=W*log_2(1+\frac{S}{N} ) \\
c:信道的极限信息传输速率(单位:bit/s)	\\
W:信道带宽(单位Hz)	\\
S:信道内所传信号的平均功率	\\
N:信道内的高斯噪声功率	\\
\frac{S}{N}:信噪(单位:分贝dB) 	\\
信噪比(dB)=10*log_{10}(\frac{S}{N})(dB)
$$
在信道的频率带宽W一定的情况下，根据奈氏准则和香农公式，要想**提高信息的传输速率**，就必须采用**多元制**（更复杂的调制技术），并努力**提高信道中的信噪比**

## 2.6 信道复用技术

### 信道复用技术的基本原理

复用（Multiplexing）就是在**一条传输媒体上同时传输多路用户的信号**

一条传输媒体的传输容量大于多条信道传输的总容量时，就可以通过复用技术，在这条传输媒体上建立多条通信信道，以便**充分利用传输媒体的带宽**

尽管实现信道复用会增加通信成本（需要复用器、分用器以及费用较高的大容量共享信道），但如果**复用的信道数量较大**，还是**比较划算**的

![image-20220927222152295](https://i0.hdslb.com/bfs/album/216a995c99d18eba82929d44926ce84fd77d8bbf.png)



### 常见的信道复用技术

![image-20220927222232318](https://i0.hdslb.com/bfs/album/2509582c10ecef85ad80b416696aa3ac58fdf858.png)

**频分复用FDM**

频分复用的所有用户**同时**占用不同的频带资源并行通信

![image-20220927222658284](https://i0.hdslb.com/bfs/album/3053bdb9af616cb2935be8af46772a65abeed049.png)

### 时分复用TDM

时分复用的所有用户**在不同的时间占用同样的频带**

**注：TDM帧是一段固定长度的时间，与数据链路层中对等实体间逻辑通信的“帧”，是完全不同的概念**

![image-20220927222748615](https://i0.hdslb.com/bfs/album/f33fefdd60ea903671d693bf8d2b18af093dbc33.png)

**波分复用WDN**

根据频分复用的设计思想，可在一根光纤上**同时传输多个频率（波长）相近的光载波信号**，实现基于光纤的频分复用技术

目前可以在一根光纤上复用80路或更多路的光载波信号。因此，这种复用技术也称为**密集波分复用DWDM**

**码分复用CDM**

码分复用（Code Division Multiplexing，CDM）常称为**码分多址**（Code Division Multiple Access，CDMA），它是在扩频通信技术的基础上发展起来的一种无线通信技术

与FDM和TDM不同，CDMA的每个用户可以**在相同的时间使用相同的频带进行通信**

- CDMA将每个比特时间划分为m个更短的时间片，称为**码片（Chip）**。m的取值通常为64或128。为了简单起见，在后续的举例中，我们假设m的取值为8
- CDMA中的每个站点都被指派一个唯一的 **m比特码片序列（Chip Sequence）**
  - 某个站要发送**比特1**，则发送它自己的**m比特码片序列**
  - 某个站要发送**比特0**，则发送它自己的**m比特码片序列的反码**
  - ![image-20221006204616252](https://i0.hdslb.com/bfs/album/85d028b37471d4b0af9789aa3c8a94023e886e9c.png)
  - ![image-20221006205113576](https://i0.hdslb.com/bfs/album/556f091fce32c5081c27d4745f2766462a8e611f.png)
  - ![image-20221006205223920](https://i0.hdslb.com/bfs/album/1650ac3404c7980ef9c6672df137dc3f28c1406b.png)
  - ![image-20221006205207962](https://i0.hdslb.com/bfs/album/c1bca99b566955b8122f31c1e537e516ba399bb8.png)

# 第三章 数据链路层

## 3.1 数据链路层概述

**局域网中的主机、交换机都必须实现数据链路层**

![image-20221006205852908](https://i0.hdslb.com/bfs/album/3c639075e80dfa729f809d662f29a3ae5140a9a1.png)

**数据链路层使用的信道**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221020202335437.png" alt="image-20221020202335437" style="zoom:67%;" />

## 3.2 点对点信道的数据链路层

**链路（Link）：**是指从一个节点到相邻节点的一段物理线路（有线或无线），而**中间没有任何其他的交换节点**

**数据链路（Data Link）**是基于链路的。当在一条链路上传送数据时，除需要链路本身，把**实现这些协议的硬件和软件加到链路上**，就构成了数据链路

**数据链路层传输的是帧**

**数据链路层的三个重要问题**

<img src="https://i0.hdslb.com/bfs/album/d6e388646a113e9d562b2afdf44f9887cf98c9ec.png" alt="image-20221006210731998" style="zoom:67%;" />

## 3.3 封装成帧和透明传输

**封装成帧是指数据链路层给上层交付下来的协议数据单元PDU添加一个首部和一个尾部，使之成为帧**

- 帧的首部和尾部中包含有一些**重要的控制信息**

- 帧首部和尾部的作用之一就是**帧定界**

  <img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221020202729292.png" alt="image-20221020202729292" style="zoom:67%;" />

**透明传输是指数据链路层对上层交付下来的协议数据单元PDU没有任何限制，就好像数据链路层不存在一样**

- 面向字节的物理链路使用**字节填充**的方法实现透明传输

  在每个 **Flag** 字符（标志字符）前加上 **ESC** 字符（转义字符），在每个 **ESC**字符前再加上一个 **ESC** 字符

- 面向比特的物理链路使用**比特填充**的方法实现透明传输

  在每5个连续的**bit1**之后添加一个**bit0**

eg：![image-20221009153403540](https://i0.hdslb.com/bfs/album/8fe5cfa116c8c73fda1654529531046cd0af14f7.png)

## 3.4 差错检测

实际的通信链路都不是理想的，比特在传输过程中可能会产生差错：1变为0，0变为1（**称为比特差错/误码**）

在一段时间内，传输错误的比特数量占所传输比特总数的比率称为**误码率（Bit Error Rate，BER）**

使用**差错检测技术**来检测数据在传输过程中是否产生了比特差错，是数据链路层所要解决的重要问题之一

**奇偶校验**

- 奇校验是在待发送数据后面**添加1个校验位**，使得添加该校验位后的整个**数据中比特1的个数为奇数**
- 偶校验是在待发送数据后面**添加1个校验位**，使得添加该校验位后的整个**数据中比特1的个数为偶数**

**循环冗余校验CRC**

- 收发双方约定好一个**生成多项式G(X)**
- 发送方基于待发送的数据和生成多项式G(X)，计算出差错检测码（**冗余码**），将冗余码添加到待发送数据的后面一起传输
- 接收方收到数据和冗余码后，通过生成多项式G(X)来计算收到的数据和冗余码是否产生了误码

<img src="https://i0.hdslb.com/bfs/album/ea5ed9720d49b60f9d3e6355dbd9d8a7146b3839.png" alt="image-20221009154724488" style="zoom: 50%;" />

<img src="https://i0.hdslb.com/bfs/album/2ab786b52607bfc65a11f945be0f4800dbc2c9f0.png" alt="image-20221009154744338" style="zoom: 50%;" />

eg：

<img src="https://i0.hdslb.com/bfs/album/ac89bf3b1f25249adebd0a5afebb6d8f7144f055.png" alt="image-20221009154936536" style="zoom:67%;" />

## 3.5 可靠传输

**数据链路层向上层提供的服务类型** 

- **不可靠传输**：仅仅**丢弃有误码的帧**，其他什么也不做

- **可靠传输**：通过某种机制实现**发送方发送什么，接收方最终就能收到什么**

  <img src="https://i0.hdslb.com/bfs/album/9e06ea8fb9936bc8048a2f7b49a75f7fad6aff7a.png" alt="image-20221009155838870" style="zoom:53%;" />

- **可靠传输服务并不局限于数据链路层**，其他各层均可选择实现可靠传输

  <img src="https://i0.hdslb.com/bfs/album/9a920c52346a73fa731558ced9f682135a58ad07.png" alt="image-20221009201145441" style="zoom:50%;" />

**实现可靠传输的三种方式 **

### 停止-等待协议SW

<img src="https://i0.hdslb.com/bfs/album/4825c3507ad6e76cb3668a5fb8d14afaacb55fc5.png" alt="image-20221009201451760" style="zoom: 67%;" />

**超时重传**

- 若DATA丢失，则不会发送ACK/NAK

- 发送方在每发送完一个数据分组时就启动一个**超时计时器（Timeout Timer）**
- 若到了超时计时器所设置的**超时重传时间（Retransmission Time-Out，RTO）**，但发送方仍未收到接收方的ACK或NAK，就重传之前已发送过的数据分组

**注：**

- 使用超时重传机制后，就可以不使用否认机制了，这样可使协议实现起来更加简单。但是，如果点对点链路的误码率较高，**使用否认机制可以使发送方在超时计时器超时前就尽快重传**
- 为了**让接收方能够判断所收到的数据分组是否是重复**的，需要给数据分组编号。由于**停止-等待协议的特性**，**只需1个比特编序号**即可，即序号0和序号1
- 为了**让发送方能够判断所收到的确认分组是否是重复**的，需要给确认分组编号，所用**比特数量与数据分组所用比特数量一样**
  - 数据链路层一般不会出现确认分组迟到的情况，因此
- 给超时计时器设置的超时重传时间RTO应当仔细选择，**一般将RTO设置为略大于收发双方的平均往返时间RTT**

**停止-等待协议的信道利用率**

<img src="https://i0.hdslb.com/bfs/album/db11c40224c6b704fa8f28ea93c3c5d7e8e7c8ff.png" alt="image-20221009210626373" style="zoom:67%;" />

### 回退N帧协议GBN

<img src="https://i0.hdslb.com/bfs/album/eedea10a68f5a065d3671147668997c5bfd38974.png" alt="image-20221009212952628" style="zoom:67%;" />

<img src="https://i0.hdslb.com/bfs/album/181446dede550f66d4f0d7d3a2a3c4cd2b26397d.png" alt="image-20221009214151548" style="zoom: 67%;" />

### 选择重传协议SR

<img src="C:\Users\18109\AppData\Roaming\Typora\typora-user-images\image-20221011220749755.png" alt="image-20221011220749755" style="zoom:67%;" />



## 3.6 点对点协议PPP

**PPP协议有3个部分**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221020204355874.png" alt="image-20221020204355874" style="zoom:67%;" />

**PPP的帧格式**

<img src="https://i0.hdslb.com/bfs/album/cda3aa44299004bf77cb27f0b0ff16039351baff.png" alt="image-20221011221238665" style="zoom:67%;" />

**PPP协议是面向字节的，所有的PPP帧的长度都是整数字节**

**透明传输方法**

- **字节填充法**

<img src="https://i0.hdslb.com/bfs/album/540b323f3b1aad99003e03d1beb4fc2abf694d73.png" alt="image-20221011222039926" style="zoom:67%;" />

- **零比特填充法**

  <img src="https://i0.hdslb.com/bfs/album/7d1d47aaa4628f169d5c6115805d0376d53e86fb.png" alt="image-20221011222257540" style="zoom:67%;" />

## 3.7 使用广播信道的数据链路层

**局域网的特点**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221020210046387.png" alt="image-20221020210046387" style="zoom:67%;" />

**局域网的拓扑结构**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221020210629708.png" alt="image-20221020210629708" style="zoom:67%;" />

**共享信道带来的问题**

- 多个设备在共享的广播信道上同时发送数据，则会造成彼此干扰，导致发送失败

**媒体（信道）的共享技术**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221020221219422.png" alt="image-20221020221219422" style="zoom:67%;" />

**局域网数据链路层**

- <img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221023100843215.png" alt="image-20221023100843215" style="zoom:67%;" />

- **MAC层：**成帧/拆帧、实现和维护MAC协议，实现差错检测与寻址
- **LLC层：**提供与上层的逻辑接口，建立释放逻辑连接，差错控制，帧序号处理等

**适配器（网卡）的作用**

- 进行串行、并行转换
- 对数据进行缓存
- 在计算机的操作系统安装设备驱动程序
- 实现以太网协议
- <img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221023101043362.png" alt="image-20221023101043362" style="zoom:50%;" />

**局域网的分类**

- **拓扑结构**
  - 总线型、星型、环型、树型
  - 传输介质：双绞线、光纤、同轴电缆
- **介质访问方法——按协议实现通信信道共享**
  - CSMA/CD
  - Token-passing（令牌机制）
- **信号传输形式**
  - 基带
  - 宽带





## 3.6 CSMA/CD

**载波监听多址接入/碰撞检测 CSMA/CD（Carrier Sense Multiple Access Collision Detection）**

<img src="https://i0.hdslb.com/bfs/album/62a734552852b1341662c79d4617a7fea836b617.png" alt="image-20221011222858444" style="zoom:67%;" />

**先听后发、边听边发、冲突停发、随机重发**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221023102153625.png" alt="image-20221023102153625" style="zoom:67%;" />

**争用期（碰撞窗口）**

<img src="https://i0.hdslb.com/bfs/album/9f45d8db28c4537cdb4124e385148cbc6a92182b.png" alt="image-20221011223200194" style="zoom:67%;" />

- 站点从发送帧开始，最多经过时长2τ （即δ→0）就可检测出所发送的帧是否遭遇了碰撞
- 因此，共享总线以太网的**端到端往返时间2τ**被称为**争用期（Contention Period）或碰撞窗口（Collision Window）**，它是一个非常重要的参数

eg：

![image-20221016214616465](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221016214616465.png)





## 3.7 MAC地址 ARP与RARP协议

**MAC地址：又称为硬件地址、物理地址**

- 当多个 主机连接在同一个广播信道上，想要实现两个主机之间的通信，MAC地址用来唯一标识主机

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221023102438564.png" alt="image-20221023102438564" style="zoom:50%;" />

**MAC帧格式**

![image-20221016222612804](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221016222612804.png)

**ARP协议：将IP地址解析成MAC地址**

**RARP协议：将MAC地址解析成IP地址**

## 3.8 扩展的局域网

**在物理层扩展以太网**

- 使用光纤
- 使用集线器：会导致**碰撞域增大**

**碰撞域/冲突域：网络中的一个站点发出的帧会与其他站点发出发帧产生碰撞或冲突的那部分网络**

**在数据链路层扩展以太网**

- 早期使用 **网桥**，现在使用 **交换机**



## 3.8 集线器与交换机的区别

**集线器**

- 工作在**半双公共模式**
- **使用集线器的以太网仍然是一个总线网**。总线上的各站点共享总线资源，**使用的还是CSMA/CD协议**
- **集线器只工作在物理层，**它的每个接口仅简单地转发比特，并不进行碰撞检测。碰撞检测的任务由各站点中的网卡负责
- 集线器一般都**有少量的容错能力和网络管理功能**

**交换机**

- 以太网交换机（以下简称交换机）本质上就是一个**多接口的网桥**
- 当交换机的接口与计算机或交换机连接时，可以工**作在全双工方式**，并能在自身内部同时连通多对接口，使每一对相互通信的计算机都能像独占传输媒体那样，**无碰撞地传输数据**，这样就**不需要使用CSMA/CD协议**
- 以太网交换机是一种 **即插即用** 设备，其内部的 **帧交换表/地址表**使用通过 **自学习算法逐渐建立起来的**
- **交换方式**
  - 存储转发方式：先缓存在处理
  - 直通方式：立即转发，但是不能进行差错检测


**以太网交换机的自学习**

- 当第一次在广播信道上发送帧是会盲目发送，每台主机都会收到，只有一台主机会接受。**交换机会记下接口与MAC地址一一对应的主机**

# 第四章 网络层

![image-20221024204013941](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221024204013941.png)

## 4.1 网络层概述

**网络层的主要任务**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221024204855300.png" alt="image-20221024204855300" style="zoom:43%;" />

**端-端通信：**两个计算机系统传输实体之间的通信

**点-点通信**

- 网络层连接从 **源端到目的端**包含了若干中间系统
- 数据链路层仅将数据帧从 **导线的一端送到另一端**

**网络层的功能**

- **完成数据包寻址和路由的功能**
- **确定路径：路由算法**
- **交换/转发**

**网络层的地址：IPv4 IPv6**

- 网络层协议定义了识别网络中数据的地址
- **地址包括网络部分和主机部分**

**网络层向上提供的两种服务**

![image-20221027140808889](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027140808889.png)

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027140906579.png" alt="image-20221027140906579" style="zoom:87%;" />

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027140921770.png" alt="image-20221027140921770" style="zoom:67%;" />

## 4.2 网际协议IP及子网划分

**网际协议IP(Internet Protocol)是TCP/IP体系中两个最住哟啊的协议之一。与IP协议配套使用的四个协议**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027141201489.png" alt="image-20221027141201489" style="zoom:50%;" /> 

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027141223670.png" alt="image-20221027141223670" style="zoom:67%;" />

### 4.2.1 虚拟互联网络

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027141355349.png" alt="image-20221027141355349" style="zoom:50%;" />

- 一般当中继系统是 **转发器/网桥时**，不成为网络互联，仍是一个网络
- 互联网都是指使用 **路由器** 进行互连的网络

- 使用IP协议的虚拟互联网成为 **IP网**
- 由于**透明传输，IP数据报可以想像在网络层中传送**

### 4.2.2 分类的IP地址

IP地址为全世界范围内唯一的32位的标识符

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027164558142.png" alt="image-20221027164558142" style="zoom:67%;" />

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027164623196.png" alt="image-20221027164623196" style="zoom:67%;" />

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027164816202.png" alt="image-20221027164816202" style="zoom:67%;" />

**在所有网络中全零全一地址不使用，所以主机数要-2**

eg：

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027170012640.png" alt="image-20221027170012640" style="zoom:67%;" />

### 4.2.3 IP地址与硬件地址

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027212611339.png" alt="image-20221027212611339" style="zoom:67%;" />

![image-20221027211722142](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027211722142.png)

- **从虚拟的IP层上看IP数据报的流动：**
  - **IP1-> (IP3->IP4->IP5->IP6->) IP2**
  - 其中**(IP3->IP4->IP5->IP6->)**是由路由器根据算法、协议进行选择，并不出现在源IP数据报中
  - 其他层是透明的
- **在链路上看MAC帧的流动：**
  - **HA1-> (HA3->HA4->HA5->HA6->) HA2**
  - 其中**(HA3->HA4->HA5->HA6->) **是由路由器根据算法、协议进行选择
  - 其他层是透明的

### 4.2.4 地址解析协议ARP和逆地址解析协议RARP

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027214047462.png" alt="image-20221027214047462" style="zoom:67%;" />

### 4.2.5 IP数据报的格式

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027214249383.png" alt="image-20221027214249383" style="zoom:67%;" />

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027214411026.png" alt="image-20221027214411026" style="zoom:67%;" />

### 4.2.6 IP层转发分组的流程

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027215116545.png" alt="image-20221027215116545" style="zoom:67%;" />

在 **路由表**中，对每一条路由最重要的是（目的网络地址，吓一跳地址）

![image-20221027221903140](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027221903140.png)

- **IP分组的首部中没有地方可以用来指明==下一跳路由器的IP地址==**

- 网络接口软件使用 **ARP** 将吓一跳路由器的IP地址转换成硬件地址，并将其放在MAC帧的首部

![image-20221027222955174](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027222955174.png)

## 4.3 划分子网和构造超网

### 4.3.1 划分子网

**划分子网就是把一个较大的网络划分成几个较小的子网，每个子网都有自己的子网地址**

**通过子网掩码来区分地址的网络部分和主机部分**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221027223140166.png" alt="image-20221027223140166" style="zoom:67%;" />

**划分子网的优点**

- 减少广播扩散的范围，提高网络安全，有利于对网络进行分层管理
- 提高IP地址利用率
- 不增增加路由表项目

![image-20221109171514918](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221109171514918.png)

**使用子网掩码找出IP地址中的子网部分**

![image-20221109195556393](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221109195556393.png)

![image-20221109195748860](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221109195748860.png)

**注：在子网划分时，全0和全1地址不可以使用，例如某个公司需要划分1000个子网实际需要1002**

![image-20221109205009708](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221109205009708.png)

### 4.3.2 划分子网的情况下路由器转发分组的算法

![image-20221109205332053](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221109205332053.png)

![image-20221109205750614](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221109205750614.png)

### 4.3.3 构成超网

**无类地址CIDR**

- 整个IP地址空间被划分为不同大小的地址块，五类地址已经不再将IP地址分为A、B和C类，而是由 **网络前缀+主机号** 构成

eg：

![image-20221109210419989](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221109210419989.png)

**最长前缀匹配**

![image-20221109211906745](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221109211906745.png)

![image-20221109211912629](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221109211912629.png)





## 4.4 网际控制报文协议 ICMP

**ICMP协议用于在主机、路由器之间传递==控制消息==。**控制消息如主机是否可达、路由是否可用、IP数据报出错等 **网络本身的情况**

### 4.4.1 ICMP报文格式及分类

![image-20221109212505130](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221109212505130.png)

**ICMP差错报告报文的数据字段的内容**



![image-20221109213727447](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221109213727447.png)

**报文类型**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221109213756844.png" alt="image-20221109213756844" style="zoom:50%;" />

**ICMP协议的应用**

- Ping命令：使用ICMP **回送和应答** 报文来确定一台主机是否可达
  - 可达：返回 **回送应答报文**
  - 不可达：返回 **终点不可达报文**
- Tracert命令：使用ICMP **时间超时报文** 来跟踪路由信息



## 4.5 因特网的路由选择协议

**IGP和EGP**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221110173925451.png" alt="image-20221110173925451" style="zoom:67%;" />



**因特网的路由策略**

- **静态路由**
  - 手工配置路由表
  - 不需要路由器来试图发现路由
- **静态路由**
  - 路由第动态适应链路状态和网络拓扑结构的变化
  - 通过**路由算法和协议**来实现
  - 常用动态路由算法：D-V路由算法和L-S路由算法

**D-V（Distance-Vector）路由算法**

- 路由器定期和邻居路由器定期交换**距离-向量表**
- 收到新的 **距离-向量表**时，重新计算到每个目的地的距离，并更新路由表
- 特点
  - 算法检点，易于配置、维护和使用
  - 距离-向量路由算法不适用于大的、复杂的网络

**L-S（Link State， 链路状态）路由算法**

- 向各个邻居传送自己直接连接的网络
- 通过各个路由器发送过来的LSA报文发，发现新的路由器和新的网络
- 各个路由器根据自己的数据库推算最佳路径
- 特点
  - 收到LSA报文立即转发，收敛速度块
  - 不会出现循环路由

### 4.5.1 路由信息协议RIP（Routing Information Protocol）

**路由信息协议RIP（Routing Information Protocol）**

- 是 **内部网关协议IGP**中最先得到广泛使用的协议
- 是一种基于 **距离向量（D-V）** 的路由选择协议 
- **使用UDP协议**
- **表交换方式**
  - 通过相邻路由器之间 **相互交换报文** 实现
  - 两类报文：**更新报文、请求报文**
  - **每隔30秒**向路由器 **广播** 路由表

- **距离的定义**

  ![image-20221110185404606](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221110185404606.png)

- 使用 **跳步数** 作为两个相邻路由器之间的距离度量值。最大跳步数为==15==
- **RIP协议允许最大距离为15，即一条路径最多包含15个路由器。距离大于16是不可见，所以RIP只适用于小型网络**

eg：

![image-20221110185647314](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221110185647314.png)

![image-20221110185707545](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221110185707545.png)

### 4.5.2 OSPF协议（Open Shortest Path First）

**OSPF协议（Open Shortest Path First）**

- 一种基于 **链路状态路由算法（L-S）** 的路由协议

- 收敛速度快，**可以适应大型网络**，**支持多条路径**负载均衡

- 不使用UDP，直接用IP数据报传送



## 4.6 IP多播



## 4.7 虚拟专用网VPN和网络地址转换NAT

**使用隧道技术（tunneling）实现虚拟专用网**

![image-20221110191016347](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221110191016347.png)

# 第五章 运输层

![image-20221110191119474](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221110191119474.png)

**传输层的作用**

- 跟踪源主机和目的主机上应用程序间的每次通信
- 数据分段
- 重组数据段
- 表示应用程序

**传输层的主要功能**

- 分段与复用
- 会话多路复用

**一些传输层协议还提供**

- 面向连接的会话
- 可靠传输
- 有序的数据重构
- 流量控制

## 5.1 运输层协议概述

### 5.1.1 进程间通信

![image-20221127222151084](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221127222151084.png)

两个主机进行通信，实际上就是两个主机中的**应用进程相互通信（端到端的通信）**

**逻辑通信：**运输层之间的通信 **好像** 是沿水平方向传输数据，但实际不是（**透明传输**）

![image-20221127222930852](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221127222930852.png)

**运输层的主要功能**

- 运输层为 **应用进程之间** 提供 **端到端的逻辑通信**
- 运输层对收到的报文进行差错检测
- 运输层提供：面向连接的TCP和无连接的UDP

### 5.1.2 运输层的两个主要协议

**用户数据报协议UDP**：UDP传送的数据单位协议是 **UDP报文/用户数据报**

**传输控制协议TCP**：TCP传送的数据单位协议是 **TCP报文段**

![image-20221128221114418](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221128221114418.png)

![image-20221128221340884](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221128221340884.png)

**使用TCP/UDP的应用**

![image-20221128221429937](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221128221429937.png)

### 5.1.3 运输层的端口

- 运行再计算机中的进程使用 **进程标识符** 来标志
- 使用 **端口** 标志应用层的进程
- 端口用一个16bit的端口号来表示
- 端口号只有本地意义

![image-20221128221607155](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221128221607155.png)

**常用协议的端口号**

![image-20221128221809408](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221128221809408.png)

## 5.2 用户数据报协议UDP

**UDP只是在IP数据报服务至上增加 ==端口的功能==（使用报文队列实现） 和 ==差错检测功能==**

**UDP协议的优点**

- 发送数据不用建立连接
- 主机不用维持连接状态
- UDP数据报只有8个字节的首部开销
- 网络拥塞时发送速率不会降低

**UDP数据报不可靠的交付，特点：**

- 无连接
- 无拥塞控制
- 使用尽最大努力交付
- 面向报文
- 支持一对一、一对多、多对一、多对多的通信

- 首部开销小

**面向报文的UDP**

- 发送方对应用程序交下来的报文，在 **添加首部** 后就向下交付网络层。UDP对应用层报文 **既不拆分，也不合并**

- UDP发送报文，应用层给多长就发多长，即 **一次发送一个报文**
- 接收方UDP对网络层交付的UDP数据报，去除首部后，直接交付进程，即 **一次交付一个完整的报文**
- 应用程序需要自己选择 **合适大小的报文**
- **UDP不会将应用层数据进行划分，这需要应用层完成**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221130170007276.png" alt="image-20221130170007276" style="zoom:67%;" />

### 5.2.2 UDP的首部格式

![image-20221130170124105](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221130170124105.png)

##  5.3 传输控制协议TCP概述

### 5.3.1 TCP最主要的特点

- TCP是 **面向连接** 的运输层协议
- 每一条TCP连接只能有两个 **端点**，没一条TCP连接只能是 **点对点（一对一）的**

- TCP提供 **可靠交付** 服务
- TCP提供 **全双工** 通信
- **面向字节流**
- **注意**
  - TCP连接是 **虚连接**，不是物理连接
  - TCP不关心，应用层给予的报文长度
  - TCP会根据 **窗口值** 和 **网络拥塞** 的程度决定报文段长度

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221130170644421.png" alt="image-20221130170644421" style="zoom:67%;" />

### 5.3.2 TCP的连接

- TCP把 **连接** 作为最基本的抽象

- 每一条TCP连接都有两个端点
- 连接端点为 **套接字/插口**
- 每一套TCP连接唯一的被通信两端的两个端点确定

$$
TCP连接::=\{socket1,\ socket2 \}\\
=\{(IP1:port1, IP2:port2)\}
$$

## 5.4 可靠传输的工作原理

### 5.4.1 停止等待协议

- **为解决==死锁==问题**

- 主机A在发送完一个报文段时，就启动一个 **超时计时器**

- 若超时计时器终止时A仍未收到主机B的任何确认，就重传前面发送的报文段

- 超时重传时间 **略大于==从发送完报文段到收到确认所需的平均时间==**<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221130175606352.png" alt="image-20221130175606352" style="zoom:80%;" />
- 使用确认和重传机制，就可以 **在不可靠的传输网络上实现可靠的通信**
- 这种实现 **可靠通信** 的传输协议常成为 **自动重传协议ARQ**

### 5.4.2 连续ARQ协议/窗口协议

- 停止等待协议的优点是简单，但缺点是**信道利用率太低**

- 发送方可 **连续发送** 多个分组，不必每发完一个分组就停顿下来

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221130180614963.png" alt="image-20221130180614963" style="zoom:50%;" />

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221130180703122.png" alt="image-20221130180703122" style="zoom:67%;" />

**累计确认**

- 接收方一般采用**累积确认**的方式。即不必对收到的分组逐个发送确认，而是对按序到达的最后一个分组发送确认，这样就表示：**到这个分组为止的所有分组都已正确收到了**
- 优点是：容易实现，即使确认丢失也不必重传。缺点是：不能向发送方反映出接收方已经正确收到的所有分组的信息

**Go-back-N（回退N）**

- 若已经发送了5个分组，第三个分组丢失，接收方只确认前两组，发送方需要再次发送后三个分组

**TCP可靠通信的具体实现**

- TCP连接的每一端都必须设有两个窗口：**一个发送窗口和一个接收窗口**
- TCP的可靠传输机制用**字节的序号**进行控制。TCP所有的确认都是**基于序号**而不是基于报文段
- TCP两端的四个窗口经常处于**动态变化之中**
- TCP连接的往返时间RTT**也不是固定不变**的。需要使用特定的算法估算较为合理的重传时间

### 

## 5.5 TCP报文段的首部格式

![image-20221130181324939](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221130181324939.png)

- **源端口和目的端口字段**：各占2字节。端口是运输层与应用层的服务接口。运输层的复用和分用功能都要通过端口才能实现。

- **序号字段**：占4字节。TCP连接中传送的数据流中的每一个字节都编上一个序号。序号字段的值则指的是本报文段所发送的数据的第一个字节的序号

- **确认号字段：**占4字节。是期望收到对方下一个报文段的数据的第一个字节的序号
- **数据偏移（即首部长度）**：占4位。他指出TCP报文段的数据起始处距离TCP报文段起始处有多远。单位为4字节
- **保留字段**：占6位，保留今后使用，全为0
- **紧急URG**：当URG=1时，表明紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快传送（相当于高优先级的数据）
- **确认ACK**：只有当ACK=1时确认号字段才有效
- **推送PSHPuSH**：接收TCP收到PSH=1的报文段，就尽快地交付接收应用进程，而不再等到整个缓存都填满了后再向上交付。

- **复位RST**：当RST=1时，表明TCP连接中出现严重差错（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立运输连接
- **同步SYN：**同步SYN=1表示这是一个 **连接请求或连接接受报文**
- **终止FIN**：用来释放一个连接。FIN=1表明发送端的数据已经发送完毕，并要求释放运输连接
- **窗口字段**：占2字节，用来让对方设置发送窗口的依据，单位为字节
- **检验和**：占2字节。检验和字段检的范围包括首部和数据这两部分。在计算检验和时，要在TCP报文段的前面加上12字节的伪首部。

- **紧急指针字段**：占16位，指出在本报文段中紧急数据共有多少个字节（紧急数据放在本报文段数据的最前面)

- **选项字段**：长度可变。**最大报文段长度MSS**、**选择确认选项**等
- **填充字段**：是首部长度位4字节的整数倍

## 5.6 TCP可靠传输的实现

**以字节为单位的滑动窗口**

**根据B给出的窗口值，A构造出自己的发送窗口**

**A先后到确认号后，发送窗口向前滑动**

**A的发送窗口内的讯号都已用完，但还没有收到确认，停止发送**

**A的发送窗口并不总是和B的接受窗口一样大（时间滞后）**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221130201725661.png" alt="image-20221130201725661" style="zoom:50%;" />

## 5.7 TCP的运输连接管理

运输连接有三个阶段：**连接建立、数据传送和连接释放**

**TCP连接的建立都是采用客户服务器方式**

- 主动发起连接建立的应用进程叫做 **客户（client）**
- 被动等待连接建立的应用进程叫做 **服务器（server）**

**连接建立：三次握手**

**连接释放：四次挥手**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221130204709314.png" alt="image-20221130204709314" style="zoom:80%;" />

## 5.8 TCP的流量控制

**TCP采用大小可变的滑动窗口进行流量控制，窗口大小单位是字节**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221130205543499.png" alt="image-20221130205543499" style="zoom:80%;" />

## 5.9 TCP的拥塞控制

出现 **拥塞** 的条件：队资源需求的总和 > 可用资源

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221130210457618.png" alt="image-20221130210457618" style="zoom:67%;" />

每一个TCP连接都有两个状态变量

- **接收端窗口rwnd/通知窗口**
- **拥塞串口cwnd**

**发送窗口的上限值=MIN[rwnd, cwmd]**

- rwnd < cwnd ,接收端接受能力限制发送窗口的最大值
- cwnd < rwnd ,网络的讯在限制发送窗口的最大值

### 5.9.1 慢开始算法

- 在主机刚刚开始发送报文段时可先将拥塞窗口cwnd设置为一个最大报文段MSS的数值。
- 在**每收到一个对新的报文段的确认**后，将拥塞窗口**cwnd加倍**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221201153503153.png" alt="image-20221201153503153" style="zoom:80%;" />

**设置慢开始门限变量ssthresh**

- 当cwnd < ssthresh时，使用 **慢开始算法**
- 当cwnd > ssthresh时，使用 **避免拥塞算法**
- **注：cwnd < ssthresh时ssthresh为初始设定值，cwnd>ssthresh时cwnd=ssthresh**

**避免拥塞算法**

- 每经过一个往返时间RTT就把发送方拥有的cwnd加1

**当出现网络拥塞时**

- 将慢开始门限ssthresh设置为出现 **拥塞时的发送方窗口值的一半（不小于2）**
- 把拥塞窗口**cwnd重新设置为1**，执行慢开始算法

### 5.9.2 快重传算法

发送端只要**一连收到三个重复的ACK即可断定有分组丢失了**，就应立即传丢失的报文段而不必继续等待为该报文段设置的重传计时器的超时

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221201155954251.png" alt="image-20221201155954251" style="zoom:80%;" />

**快恢复算法**

当发送端收到连续三个重复的ACK时，就重新设置慢开始门限ssthresh。有不同方案：

1. 将$ssthresh=cwnd/2$
2. 与慢开始不同之处是拥塞窗口cwnd不是设置为1，而是设置为$ssthresh+3×MSS$
3. 若收到的重复的ACK为n个(n>3),则将cwnd设置为$ssthresh+n×MSS$

# 第六章 应用层

![image-20221201170243646](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221201170243646.png)

## 6.1 应用层概述

### 6.1.1 应用层的地位和作用

- **应用层时计算机网络体系结构中的最高层，也是唯一面向用户的一层**
- 应用层将**为用户提供常用的应用程序**，并**实现网络服务的各种功能**
- 常用的电子邮件、浏览器等网络服务都是应用层的程序

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221201185629052.png" alt="image-20221201185629052" style="zoom:80%;" />

**应用程序的实现结构**

- **对称的对等模式**
  - 应用进程的地位和作用平等，eg：视频会议系统
- **非对称的客服/服务器模式==主要使用==**
  - 客户端确定如何请求服务
  - 服务器决定何时和如何提供服务

### 6.1.2 客/服务器模式的应用

- **客户处于主动地位，向服务器发出各种请求**
- **服务器处于被动地位，根据客户请求提供相应的服务**
- **优势**
  - 实现计算机资源与信息资源的共享
  - 提高网络的运行效率
  - 便于数据的维护和管理
  - 充分发挥服务去和客户机各自的优势
    - 服务器：存储量大、超级计算、信息资源丰富
    - 客户机：灵活方便

**客户机/服务器之间的通信**

- **传输层协议**
  - **可以是TCP协议**
  - **可以是UDP协议**
  - **可以同时使用TCP和UDP协议**

- 客户和服务器的交互
  - 使用TCP/IP协议栈完成，所以**客户和服务器所在的机器要求支持完全的协议栈**。客户/服务器通过 **套接字** 访问传输层服务

### 6.1.3 域名服务DNS

**32bit的IP地址难于记忆，所以文本使用文本描述的域名服务**

**文本描述->IP地址**

**域名的作用**

- 具有层次结构，提供网络管理组织信息
- 便于网络管理和维护：IP地址可以随网络变化，域名可以保持不变
- IP地址与域名地址是一对多的关系，**一个IP可以被多个域名同时索引**

**域名解析方法**

- **递归解析**

  一次域名服务请求即可自动完成域名/IP地址之间的转换

- **迭代解析**

**域名的名字空间**

- **跟**
- 在根下的 **顶级（top）域名**
  - 3字符域：generic（通用域）
  - 2字符域：country（国家域）
- 在某个顶级域名下的 **第二级域名**
- 在某个第二级域名下的 **第三级域名**
- **叶：主机域名**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20230129101241301.png" alt="image-20230129101241301" style="zoom:80%;" />

- **域名命名**

  **主机名.最低级域名. ··· .最高级域名**

  域名对大小写不敏感，子符名不超过 **63个字符**，全名不超过 **255个字符**

**域名服务器**

- 记录所有第二级域名的DNS信息
- 分布在网络的不同地方，具有公开的IP地址
- 功能
  - 记录本域内的域名注册信息
  - 提供IP地址/域名的解析服务
  - 提供域名信息查询服务
- 全球一共有 **13台不同IP地址的根域名服务器，从a-m**，10台在美国，英国、瑞典和日本各一台

## 6.2 常用的Internet服务

![image-20221201210227912](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221201210227912.png)

### 6.2.1 文件传送协议FTP

TCP/IP的一个重要应用就是 **文件传送**

- **文件传送协议FTP**
- **简单文件传送协议TFTP**
- **网络文件系统NFS**

**文件传送协议FTP**

- **文件传送协议FTP**是使用最广泛的文件传送
- **FTP**是基于 **TCP协议的文件传输**

- **FTP使用客户服务器方式**，一个FTP服务器进程 **可同时为多个客户进程提供服务**
  - 一个 **主进程** 复杂接受新的请求
  - **若干给从属进程** 父子处理单个请求
- **FTP控制连接使用端口号为21，数据连接使用端口号为20 **

**简单文件传送协议TFTP**

- 是一个很小且易于实现的文件传送协议
- **优点**
  - 可用于UDP环境
  - TFTP代码所占的内存较小
- **特点**
  - 每次传送的数据的PDU中有512字节，最后一字节可不足512
  - 支持ASCII码或二进制传送
  - 可对文件进行读写

**网络文件系统NFS**

- 网络文件系统NFS除了实现文件和目录共享外，还允许应用进程打开一个远地文件，并能够在该文件的某一个特定的位置上开始读写数据

### 6.2.2 远程登录Telnet

- 远程登录Telnet是一个简单的 **远程终端协议**
- 用户用Telnet可以通过TCP远程连接到另一台主机上
- Telnet使用 **客户/服务器模式**
- **Telnet再功能上**模拟乘远端一部电脑系统的终端机，称为 **网络虚拟终端NVT(Network virtual Terminal)，通过网络连线载入该电脑系统，可以执行该电脑系统的任何程序**

### 6.2.3 电子邮件 Email

**简单邮件传送协议SMTP**

**邮件读取协议POP3、IMAP4**

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221203210629099.png" alt="image-20221203210629099" style="zoom:67%;" />

**电子邮件的主要构建**

- **用户代理（UA：User Agent）又称邮件阅读器：**编辑、发送、阅读和管理电子邮件
- **传输代理（MTA：Message Transfer Agent）又称邮件服务器：**起 **邮局** 作用，接受用户邮件，根据地址传输，传送接收方的邮件服务器，并将邮件存放在用户邮箱

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221203205748945.png" alt="image-20221203205748945" style="zoom:80%;" />

**电子邮件工作模式**

- **邮件服务器之间采用==存储转发==的工作方式**
- 邮件服务器之间通过**简单邮件传输协议（SMTP）**进行对话，TCP端口号为25
- **发送邮件时**,邮件阅读器就通过和邮件服务器建立**SMTP连接**,将编辑好的邮件发给邮件服务器;
- **读取邮件时**,邮件阅读器则和邮件服务器通过建立**POP连接**,将邮件从邮件服务器上读取到本地计算机上

**居于HTTP协议的电子邮件**

- **使用HTTP协议发送邮件到服务器，服务器通过SMTP传送**

**通用因特网邮件扩充MIME**

- **SMTP的缺点**
  - 不能传送可执行文件或其他二进制对象
  - 只限于7位ASCII码
  - SMTP会拒绝一定长度邮件
- **MIME的特点**
  - **MIME不是SMTP的替代品，只是扩充**
  - MIME定义了传送非ASCII码的编码规则

<img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20221203211107427.png" alt="image-20221203211107427" style="zoom:80%;" />

### 6.2.4 万维网（World Wide Web）

- 万维网是一个分布式的超媒体系统，他是超文本系统的扩充

- 万维网一客户机/服务器方式工作

- 万维网通过 **连接** 提供分布式服务

- 万维网通过 **统一定位资源URL（Uniform Resource Locator）来标记万维网上的各种资源**

  <img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20230129102105459.png" alt="image-20230129102105459" style="zoom:80%;" />

- **万维网在应用层使用HTTP协议，它在传输层使用TCP连接进行可靠传输**

**HTTP协议**

- **HTTP协议的运作方式**

  <img src="https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20230129102346995.png" alt="image-20230129102346995" style="zoom:80%;" />

- **HTTP协议下客户/服务器模式中信息交换的实现**
  - 建立连接：通过申请套接字（Socket）实现
  - 发送请求
  - 发送响应
  - 关闭连接

- **HTTP的报文结构**

  - **HTTP的两类报文：**从客户到服务器的 **请求报文** 和从服务器到客户的 **响应报文**

    ![image-20230129102654348](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20230129102654348.png)

  - **请求报文的一些方法**

![image-20230129102831115](https://picogo-1314393134.cos.ap-nanjing.myqcloud.com/markdown/image-20230129102831115.png)
